# Local Development Override
# This file is automatically loaded by Docker Compose for local development
# Services run with local build contexts and localhost ports
#
# ⚠️  SECURITY NOTE: Some services run as root in development for convenience
# with volume mounts. This is ONLY acceptable in local development environments.
# Production deployments use docker-compose.prod.yml which runs all services
# as non-root users with proper security hardening.

services:
  # ═════════════════════════════════════════════════════════════════════════════
  # NGINX - Local Development Configuration
  # ═════════════════════════════════════════════════════════════════════════════
  nginx:
    build:
      context: ./infrastructure/nginx
      dockerfile: Dockerfile
    ports:
      - "8080:80"     # HTTP on localhost:8080
      - "8443:443"    # HTTPS on localhost:8443 (self-signed)
      # Note: Minecraft port 25565 exposed directly by minecraft container
    volumes:
      - ./infrastructure/nginx/conf.d:/etc/nginx/conf.d:ro
      - ./infrastructure/nginx/dev-certs:/etc/nginx/certs:ro  # Self-signed certs for dev
      - ./infrastructure/nginx/logs:/var/log/nginx

  # ═════════════════════════════════════════════════════════════════════════════
  # Personal Website - Local Build
  # ═════════════════════════════════════════════════════════════════════════════
  personal-website:
    build:
      context: ./infrastructure/personal-website/frontend
      dockerfile: Dockerfile
      target: builder  # Use builder stage with dependencies installed
    user: root  # DEV ONLY: Required for npm install to write to mounted node_modules volume
    command: sh -c "npm install --legacy-peer-deps && npm run dev"  # Install deps and run dev mode
    environment:
      - NODE_ENV=development
      - NUXT_PUBLIC_API_BASE=/api
      - API_URL=http://flask-api:5000
    ports:
      - "3000:3000"  # Direct access for development
    volumes:
      # Mount source code for hot reloading
      - ./infrastructure/personal-website/frontend:/app
      - personal-website-node-modules:/app/node_modules  # Named volume for node_modules persistence

  # ═════════════════════════════════════════════════════════════════════════════
  # Flask API - Local Build
  # ═════════════════════════════════════════════════════════════════════════════
  flask-api:
    build:
      context: ./infrastructure/flask-api/backend
      dockerfile: Dockerfile
    environment:
      - FLASK_ENV=development
      - FLASK_DEBUG=1
      - DATABASE_URL=postgresql://user:pass@postgres:5432/dbname
    ports:
      - "5001:5000"  # Direct access for development (5000 conflicts with macOS AirPlay)
    volumes:
      # Mount source code for hot reloading
      - ./infrastructure/flask-api/backend:/app

  # ═════════════════════════════════════════════════════════════════════════════
  # JupyterHub - Local Build
  # ═════════════════════════════════════════════════════════════════════════════
  jupyterhub:
    # Config is generated inline in main compose file
    user: root  # DEV ONLY: Required to write config to /srv/jupyterhub volume
    ports:
      - "8000:8000"  # Direct access to proxy for development

  jupyterhub-proxy:
    # No changes needed - uses default config

  # ═════════════════════════════════════════════════════════════════════════════
  # Development Services with Direct Port Access
  # ═════════════════════════════════════════════════════════════════════════════
  opensearch:
    ports:
      - "9200:9200"  # Direct access to OpenSearch API
      - "9300:9300"  # OpenSearch cluster communication
    volumes:
      - opensearch_data_local:/usr/share/opensearch/data  # Separate volume for local data

  opensearch-dashboards:
    ports:
      - "5601:5601"  # Direct access to dashboards

  prometheus:
    ports:
      - "9090:9090"  # Direct access to Prometheus

  grafana:
    ports:
      - "3001:3000"  # Direct access to Grafana (avoid conflict with website)

  cadvisor:
    ports:
      - "8081:8080"  # Direct access to cAdvisor

  minecraft:
    ports:
      - "25565:25565"  # Direct access to Minecraft server
    volumes:
      - minecraft_data_local:/data  # Separate volume for local data

# ═════════════════════════════════════════════════════════════════════════════
# Local Development Volumes (separate from production)
# ═════════════════════════════════════════════════════════════════════════════
volumes:
  personal-website-node-modules:
  jupyter_data_local:
  opensearch_data_local:
  minecraft_data_local:

# ═════════════════════════════════════════════════════════════════════════════
# Development Environment Variables
# Load from .env file in project root
# ═════════════════════════════════════════════════════════════════════════════