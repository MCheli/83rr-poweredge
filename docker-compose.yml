# 83RR PowerEdge Infrastructure
# Base Docker Compose configuration for all services
# Auto-loads docker-compose.override.yml for local development
# Use docker-compose.prod.yml for production deployment

services:
  # ═════════════════════════════════════════════════════════════════════════════
  # NGINX Reverse Proxy (will replace Traefik)
  # ═════════════════════════════════════════════════════════════════════════════
  nginx:
    build:
      context: ./infrastructure/nginx
      dockerfile: Dockerfile
    container_name: nginx
    restart: unless-stopped
    environment:
      - INFRASTRUCTURE_ENV=${INFRASTRUCTURE_ENV:-production}
    ports:
      - "80:80"
      - "443:443"
      # Note: Minecraft port 25565 added in prod override (docker-compose.prod.yml)
    volumes:
      - ./infrastructure/nginx/conf.d:/etc/nginx/conf.d:ro
      - ./infrastructure/nginx/certs:/etc/nginx/certs:ro
      - ./infrastructure/nginx/logs:/var/log/nginx
    # depends_on:
    #   - personal-website
    #   - flask-api
    #   - jupyter
    networks:
      - infrastructure

  # ═════════════════════════════════════════════════════════════════════════════
  # Personal Website (Nuxt.js)
  # ═════════════════════════════════════════════════════════════════════════════
  personal-website:
    build:
      context: ./infrastructure/personal-website/frontend
      dockerfile: Dockerfile
    container_name: personal-website
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - NUXT_PUBLIC_API_BASE=/api
      - API_URL=http://flask-api:5000
    networks:
      - infrastructure
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  # ═════════════════════════════════════════════════════════════════════════════
  # Flask API Service
  # ═════════════════════════════════════════════════════════════════════════════
  flask-api:
    build:
      context: ./infrastructure/flask-api/backend
      dockerfile: Dockerfile
    container_name: flask-api
    restart: unless-stopped
    environment:
      - FLASK_ENV=production
      - DATABASE_URL=postgresql://user:pass@postgres:5432/dbname
    networks:
      - infrastructure
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  # ═════════════════════════════════════════════════════════════════════════════
  # JupyterHub (Data Science Environment - Multi-User)
  # ═════════════════════════════════════════════════════════════════════════════

  # JupyterHub Proxy (Configurable HTTP Proxy)
  jupyterhub-proxy:
    image: quay.io/jupyterhub/configurable-http-proxy:5
    container_name: jupyterhub-proxy
    restart: unless-stopped
    command:
      - --ip=0.0.0.0
      - --port=8000
      - --api-ip=0.0.0.0
      - --api-port=8001
      - --default-target=http://jupyterhub:8081
      - --error-target=http://jupyterhub:8081/hub/error
    environment:
      - CONFIGPROXY_AUTH_TOKEN=${CONFIGPROXY_AUTH_TOKEN}
    networks:
      - infrastructure
      - jupyterhub

  # JupyterHub Main Server
  jupyterhub:
    build:
      context: ./infrastructure/jupyter
      dockerfile: Dockerfile
    container_name: jupyterhub
    restart: unless-stopped
    depends_on:
      - jupyterhub-proxy
      - jupyterhub-db
    environment:
      - CONFIGPROXY_AUTH_TOKEN=${CONFIGPROXY_AUTH_TOKEN}
      - JUPYTER_PASSWORD=${JUPYTER_PASSWORD}
      - ADMIN_USER=${JUPYTER_ADMIN_USER}
      - SINGLEUSER_IMAGE=ghcr.io/mcheli/jupyter:latest
      - TZ=${TZ:-America/New_York}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
    command:
      - /bin/sh
      - -lc
      - |
        set -e

        # Create JupyterHub configuration
        mkdir -p /srv/jupyterhub
        printf '%s\n' \
        "import os" \
        "from dockerspawner import DockerSpawner" \
        "" \
        "c = get_config()" \
        "" \
        "# --- Hub ↔ Proxy networking ---" \
        "c.JupyterHub.bind_url = 'http://:8081'" \
        "c.JupyterHub.hub_bind_url = 'http://:8081'" \
        "c.JupyterHub.hub_connect_url = 'http://jupyterhub:8081'" \
        "c.ConfigurableHTTPProxy.should_start = False" \
        "c.ConfigurableHTTPProxy.api_url = 'http://jupyterhub-proxy:8001'" \
        "c.ConfigurableHTTPProxy.auth_token = os.environ['CONFIGPROXY_AUTH_TOKEN']" \
        "" \
        "# --- Hub DB: Postgres ---" \
        "pw = os.environ.get('POSTGRES_PASSWORD', '')" \
        "c.JupyterHub.db_url = f'postgresql://jhub:{pw}@jupyterhub-db:5432/jhub'" \
        "" \
        "# --- Spawner: each user is a container on same network ---" \
        "c.JupyterHub.spawner_class = DockerSpawner" \
        "c.DockerSpawner.use_internal_ip = True" \
        "c.DockerSpawner.network_name = 'jupyterhub'" \
        "c.DockerSpawner.remove = True" \
        "" \
        "# Use custom pre-built image with all packages and extensions" \
        "c.DockerSpawner.image = os.environ.get('SINGLEUSER_IMAGE', 'ghcr.io/mcheli/jupyter:latest')" \
        "" \
        "# Resource limits and user environment" \
        "c.DockerSpawner.mem_limit = '4G'" \
        "c.DockerSpawner.cpu_limit = 2.0" \
        "c.DockerSpawner.volumes = {" \
        "    'jupyterhub-user-{username}': '/home/jovyan'," \
        "    'jupyterhub-shared': {'bind': '/home/jovyan/shared', 'mode': 'rw'}" \
        "}" \
        "c.DockerSpawner.notebook_dir = '/home/jovyan'" \
        "c.Spawner.default_url = '/lab'" \
        "" \
        "# Enhanced environment variables" \
        'c.Spawner.environment = {' \
        '    "TZ": os.environ.get("TZ", "America/New_York"),' \
        '    "JUPYTERHUB_SINGLEUSER_APP": "jupyter_server.serverapp.ServerApp",' \
        '    "JUPYTER_ENABLE_LAB": "yes",' \
        '    "CHOWN_HOME": "yes",' \
        '    "CHOWN_HOME_OPTS": "-R",' \
        '    "OPENAI_API_KEY": os.environ.get("OPENAI_API_KEY", ""),' \
        '    "ANTHROPIC_API_KEY": os.environ.get("ANTHROPIC_API_KEY", "")' \
        '}' \
        "" \
        "# Extended timeouts for package installation" \
        "c.Spawner.http_timeout = 600" \
        "c.Spawner.start_timeout = 600" \
        "" \
        "# --- Auth: Simple password authentication ---" \
        "c.JupyterHub.authenticator_class = 'jupyterhub.auth.DummyAuthenticator'" \
        "c.DummyAuthenticator.password = os.environ['JUPYTER_PASSWORD']" \
        "admin_user = os.environ.get('ADMIN_USER')" \
        "if admin_user:" \
        "    c.Authenticator.admin_users = {admin_user}" \
        "" \
        "# --- Idle culler service ---" \
        "c.JupyterHub.services = [" \
        "    {" \
        "        'name': 'idle-culler'," \
        "        'admin': True," \
        "        'command': [" \
        "            'python3', '-m', 'jupyterhub_idle_culler'," \
        "            '--timeout=7200'," \
        "            '--cull-every=600'," \
        "            '--concurrency=10'," \
        "            '--max-age=0'" \
        "        ]," \
        "    }" \
        "]" \
        "" \
        "# Service permissions" \
        "c.JupyterHub.load_roles = [" \
        "    {" \
        "        'name': 'idle-culler-role'," \
        "        'scopes': ['list:users', 'read:users:activity', 'servers', 'delete:servers']," \
        "        'services': ['idle-culler']," \
        "    }" \
        "]" \
        > /srv/jupyterhub/jupyterhub_config.py

        # Install JupyterHub dependencies
        pip install --no-cache-dir \
          'dockerspawner>=13.0.0' \
          'jupyterlab>=4.0.0' \
          'notebook' \
          'docker' \
          'jupyterhub-idle-culler' \
          'psycopg2-binary'

        exec jupyterhub -f /srv/jupyterhub/jupyterhub_config.py
    volumes:
      - jupyterhub_data:/srv/jupyterhub
      - jupyterhub_shared:/srv/shared
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - infrastructure
      - jupyterhub

  # PostgreSQL Database for JupyterHub
  jupyterhub-db:
    image: postgres:16-alpine
    container_name: jupyterhub-db
    restart: unless-stopped
    environment:
      - POSTGRES_DB=jhub
      - POSTGRES_USER=jhub
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_INITDB_ARGS=--encoding=UTF-8 --lc-collate=C --lc-ctype=C
    volumes:
      - jupyterhub_db_data:/var/lib/postgresql/data
    networks:
      - jupyterhub
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U jhub -d jhub"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ═════════════════════════════════════════════════════════════════════════════
  # OpenSearch (Logging Infrastructure)
  # ═════════════════════════════════════════════════════════════════════════════
  opensearch:
    image: opensearchproject/opensearch:latest
    container_name: opensearch
    restart: unless-stopped
    environment:
      - cluster.name=opensearch-cluster
      - node.name=opensearch-node1
      - discovery.type=single-node
      - bootstrap.memory_lock=true
      - "OPENSEARCH_JAVA_OPTS=-Xms512m -Xmx512m"
      - "DISABLE_INSTALL_DEMO_CONFIG=true"
      - "DISABLE_SECURITY_PLUGIN=true"
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      - opensearch_data:/usr/share/opensearch/data
    networks:
      - infrastructure

  # ═════════════════════════════════════════════════════════════════════════════
  # OpenSearch Dashboards (Logging UI)
  # ═════════════════════════════════════════════════════════════════════════════
  opensearch-dashboards:
    image: opensearchproject/opensearch-dashboards:latest
    container_name: opensearch-dashboards
    restart: unless-stopped
    environment:
      - OPENSEARCH_HOSTS=http://opensearch:9200
      - "DISABLE_SECURITY_DASHBOARDS_PLUGIN=true"
    depends_on:
      - opensearch
    networks:
      - infrastructure

  # ═════════════════════════════════════════════════════════════════════════════
  # Minecraft Server
  # ═════════════════════════════════════════════════════════════════════════════
  minecraft:
    image: itzg/minecraft-server:latest
    container_name: minecraft
    restart: unless-stopped
    environment:
      - EULA=TRUE
      - TYPE=PAPER
      - VERSION=LATEST
      - MEMORY=2G
      - DIFFICULTY=normal
      - MOTD="83RR PowerEdge Minecraft Server"
      - ENABLE_WHITELIST=false
    volumes:
      - minecraft_data:/data
    networks:
      - infrastructure

  # ═════════════════════════════════════════════════════════════════════════════
  # Monitoring: Prometheus (Metrics Database)
  # ═════════════════════════════════════════════════════════════════════════════
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    restart: unless-stopped
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--web.enable-lifecycle'
      - '--storage.tsdb.retention.time=30d'
    volumes:
      - ./infrastructure/monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    networks:
      - infrastructure

  # ═════════════════════════════════════════════════════════════════════════════
  # Monitoring: Grafana (Visualization Dashboards)
  # ═════════════════════════════════════════════════════════════════════════════
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: unless-stopped
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin123
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - grafana_data:/var/lib/grafana
      - ./infrastructure/monitoring/grafana-dashboard.json:/etc/grafana/provisioning/dashboards/dashboard.json:ro
    depends_on:
      - prometheus
    networks:
      - infrastructure

  # ═════════════════════════════════════════════════════════════════════════════
  # Monitoring: cAdvisor (Container Metrics)
  # ═════════════════════════════════════════════════════════════════════════════
  cadvisor:
    image: gcr.io/cadvisor/cadvisor:latest
    container_name: cadvisor
    restart: unless-stopped
    user: "0"
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:rw
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
    networks:
      - infrastructure

# ═════════════════════════════════════════════════════════════════════════════
# Networks
# ═════════════════════════════════════════════════════════════════════════════
networks:
  infrastructure:
    driver: bridge
  jupyterhub:
    name: jupyterhub
    driver: bridge

# ═════════════════════════════════════════════════════════════════════════════
# Volumes
# ═════════════════════════════════════════════════════════════════════════════
volumes:
  jupyterhub_data:
  jupyterhub_shared:
  jupyterhub_db_data:
  opensearch_data:
  minecraft_data:
  prometheus_data:
  grafana_data: