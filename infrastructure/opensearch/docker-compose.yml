services:
  opensearch:
    image: opensearchproject/opensearch:latest
    container_name: opensearch
    restart: unless-stopped
    environment:
      - cluster.name=opensearch-cluster
      - node.name=opensearch
      - discovery.type=single-node
      - bootstrap.memory_lock=true
      - "OPENSEARCH_JAVA_OPTS=-Xms1g -Xmx1g"
      - "DISABLE_INSTALL_DEMO_CONFIG=true"
      - "DISABLE_SECURITY_PLUGIN=true"
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      - opensearch_data:/usr/share/opensearch/data
    networks:
      - opensearch_net
      - traefik_default
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.opensearch.rule=Host(`opensearch-local.ops.markcheli.com`)"
      - "traefik.http.routers.opensearch.entrypoints=websecure"
      - "traefik.http.routers.opensearch.tls=true"
      - "traefik.http.routers.opensearch.middlewares=lan-only@docker"
      - "traefik.http.services.opensearch.loadbalancer.server.port=9200"

  opensearch-dashboards:
    image: opensearchproject/opensearch-dashboards:latest
    container_name: opensearch-dashboards
    restart: unless-stopped
    environment:
      - 'OPENSEARCH_HOSTS=["http://opensearch:9200"]'
      - "DISABLE_SECURITY_DASHBOARDS_PLUGIN=true"
    volumes:
      - opensearch_dashboards_data:/usr/share/opensearch-dashboards/data
    depends_on:
      - opensearch
    networks:
      - opensearch_net
      - traefik_default
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik_default"
      - "traefik.http.routers.dashboards.rule=Host(`logs-local.ops.markcheli.com`)"
      - "traefik.http.routers.dashboards.entrypoints=websecure"
      - "traefik.http.routers.dashboards.tls=true"
      - "traefik.http.routers.dashboards.middlewares=lan-only@docker"
      - "traefik.http.services.dashboards.loadbalancer.server.port=5601"

  fluent-bit-config:
    image: busybox
    container_name: fluent-bit-config
    volumes:
      - fluent_bit_config:/fluent-bit/etc
    command: |
      sh -c "
      cat > /fluent-bit/etc/fluent-bit.conf << 'EOF'
      [SERVICE]
          Flush         5
          Log_Level     info
          Daemon        off
          Parsers_File  parsers.conf
          HTTP_Server   On
          HTTP_Listen   0.0.0.0
          HTTP_Port     2020

      [INPUT]
          Name              tail
          Path              /var/lib/docker/containers/*/*.log
          Parser            docker
          Tag               docker.*
          Refresh_Interval  5
          Mem_Buf_Limit     50MB
          Skip_Long_Lines   On
          Skip_Empty_Lines  On
          DB                /fluent-bit/data/tail_docker.db
          DB.sync           normal
          docker_mode       On
          docker_mode_flush 5

      [FILTER]
          Name          record_modifier
          Match         docker.*
          Record        level info

      [FILTER]
          Name          modify
          Match         docker.*
          Add           environment homelab
          Add           infrastructure 83rr-poweredge

      [OUTPUT]
          Name            opensearch
          Match           docker.*
          Host            opensearch
          Port            9200
          Index           logs-homelab
          Type            _doc
          Time_Key        @timestamp
          Time_Key_Format %Y-%m-%dT%H:%M:%S.%L
          Time_Key_Nanos  Off
          tls             Off
          Suppress_Type_Name On
      EOF

      cat > /fluent-bit/etc/parsers.conf << 'EOF'
      [PARSER]
          Name        docker
          Format      json
          Time_Key    time
          Time_Format %Y-%m-%dT%H:%M:%S.%LZ
          Time_Keep   On
          Decode_Field_As escaped_utf8 log do_next
          Decode_Field_As json log
      EOF
      echo 'Fluent Bit config created'
      sleep 5
      "

  fluent-bit:
    image: fluent/fluent-bit:3.1.9
    container_name: fluent-bit
    restart: unless-stopped
    user: root
    volumes:
      - fluent_bit_config:/fluent-bit/etc
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - fluent_bit_data:/fluent-bit/data
    environment:
      - FLB_LOG_LEVEL=info
    command: ["/fluent-bit/bin/fluent-bit", "--config", "/fluent-bit/etc/fluent-bit.conf"]
    depends_on:
      - opensearch
      - fluent-bit-config
    networks:
      - opensearch_net

volumes:
  opensearch_data:
  opensearch_dashboards_data:
  fluent_bit_data:
  fluent_bit_config:

networks:
  opensearch_net:
    driver: bridge
  traefik_default:
    external: true